<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Accounts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .container { min-height: 100vh; padding-top: 20px; }
        .card { padding: 15px; border-radius: 10px; }
        .action-btn { margin-top: 10px; }
        .badge-pending { background-color: #ffc107; }
        .badge-verified { background-color: #28a745; }
        .badge-rejected { background-color: #dc3545; }
        .mission-text { 
            max-height: 100px; 
            overflow-y: auto; 
            font-size: 0.9rem; 
        }
        .more-info {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .show-more-btn {
            cursor: pointer;
            color: #0d6efd;
        }
    </style>
</head>
<body>

    {% include 'nav.html' %}

    <div class="container">
        <h2 class="text-center mb-4">Organizations</h2>

        <div class="row">
            {% for organization in organizations %}
            <div class="col-lg-4 col-md-6 mb-4 organization-card">
                <div class="card shadow">
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between">
                            {{ organization.org_name }} 
                            <span class="badge badge-{{ organization.status }}">{{ organization.status|title }}</span>
                        </h5>
                        <p><strong>ID:</strong> {{ organization.id }}</p>
                        <p><strong>Email:</strong> <a href="mailto:{{ organization.email }}">{{ organization.email }}</a></p>
                        <p><strong>Phone:</strong> <a href="tel:{{ organization.phone }}">{{ organization.phone }}</a></p>
                        <p><strong>Location:</strong> {{ organization.city }}, {{ organization.state }}</p>
                        <p><strong>Category:</strong> {{ organization.org_type }}</p>
                        
                        {% if organization.reg_number %}
                        <p class="show-more-btn text-center mb-2" data-target="more-info-{{ organization.id }}">Show more details</p>
                        
                        <div class="more-info" id="more-info-{{ organization.id }}">
                            {% if organization.website %}
                            <p><strong>Website:</strong> <a href="{{ organization.website }}" target="_blank">{{ organization.website }}</a></p>
                            {% endif %}
                            
                            {% if organization.social_media %}
                            <p><strong>Social Media:</strong> {{ organization.social_media }}</p>
                            {% endif %}
                            
                            {% if organization.address %}
                            <p><strong>Address:</strong> {{ organization.address }}</p>
                            {% endif %}
                            
                            <p><strong>Registration No:</strong> {{ organization.reg_number }}</p>
                            
                            {% if organization.years_operation %}
                            <p><strong>Years in Operation:</strong> {{ organization.years_operation }}</p>
                            {% endif %}
                            
                            {% if organization.emergency_contact %}
                            <p><strong>Emergency Contact:</strong> {{ organization.emergency_contact }}</p>
                            {% endif %}
                            
                            {% if organization.rep_name %}
                            <p><strong>Representative:</strong> {{ organization.rep_name }}</p>
                            {% endif %}
                            
                            {% if organization.mission %}
                            <p><strong>Mission:</strong></p>
                            <div class="mission-text">{{ organization.mission }}</div>
                            {% endif %}
                            
                            {% if organization.reg_certificate %}
                            <p><strong>Registration Certificate:</strong> <a href="{{ organization.reg_certificate }}" target="_blank">View</a></p>
                            {% endif %}
                            
                            {% if organization.tax_certificate %}
                            <p><strong>Tax Certificate:</strong> <a href="{{ organization.tax_certificate }}" target="_blank">View</a></p>
                            {% endif %}
                            
                            {% if organization.rep_id_proof %}
                            <p><strong>Rep ID Proof:</strong> <a href="{{ organization.rep_id_proof }}" target="_blank">View</a></p>
                            {% endif %}
                        </div>
                        
                        <div class="status-actions mt-3">
                            {% if organization.status == 'pending' %}
                                <button class="btn btn-success w-100 action-btn status-btn mb-2" 
                                        data-org-id="{{ organization.id }}" 
                                        data-status="verified">Approve</button>
                                        
                                <button class="btn btn-danger w-100 action-btn status-btn mb-2" 
                                        data-org-id="{{ organization.id }}" 
                                        data-status="rejected">Reject</button>
                            {% elif organization.status == 'verified' %}
                                <button class="btn btn-warning w-100 action-btn status-btn mb-2" 
                                        data-org-id="{{ organization.id }}" 
                                        data-status="pending">Reset to Pending</button>
                            {% elif organization.status == 'rejected' %}
                                <button class="btn btn-warning w-100 action-btn status-btn mb-2" 
                                        data-org-id="{{ organization.id }}" 
                                        data-status="pending">Reset to Pending</button>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <button class="btn btn-danger w-100 action-btn delete-btn mt-2" 
                                data-org-id="{{ organization.id }}">Delete</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Toggle more information
            $(".show-more-btn").click(function() {
                const targetId = $(this).data("target");
                const $target = $("#" + targetId);
                
                if ($target.css("max-height") === "0px" || $target.css("max-height") === "0") {
                    $target.css("max-height", "500px");
                    $(this).text("Hide details");
                } else {
                    $target.css("max-height", "0");
                    $(this).text("Show more details");
                }
            });
            
            // Status update buttons
            $(".status-btn").click(function() {
                const orgId = $(this).data("org-id");
                const newStatus = $(this).data("status");
                const card = $(this).closest('.organization-card');
                
                $.post(`/update_organization_status/${orgId}/${newStatus}`, function(response) {
                    if (response.success) {
                        // Refresh the page to show updated status and buttons
                        location.reload();
                    } else {
                        alert("Error updating status: " + response.message);
                    }
                }).fail(function() {
                    alert("Server error while updating status.");
                });
            });
            
            // Delete organization
            $(".delete-btn").click(function() {
                const orgId = $(this).data("org-id");
                const card = $(this).closest('.organization-card');
                
                if (confirm("Are you sure you want to delete this organization?")) {
                    $.post(`/delete_organization/${orgId}`, function(response) {
                        if (response.success) {
                            card.fadeOut(500, function() {
                                $(this).remove();
                            });
                        } else {
                            alert("Error deleting organization: " + response.message);
                        }
                    }).fail(function() {
                        alert("Server error while deleting.");
                    });
                }
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>